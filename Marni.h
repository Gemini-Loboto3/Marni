#pragma once
#include "dxgl\dxgldraw.h"
#include "dxgl\include\ddraw.h"
#include "dxgl\include\d3d.h"
#include "MarniSurface.h"
#include "MarniUtil.h"
#include "MarniPrim.h"

#define PUTD3DINSTRUCTION(op, sz, cnt, ptr) \
(   ((LPD3DINSTRUCTION) ptr)->bOpcode = op, \
    ((LPD3DINSTRUCTION) ptr)->bSize = sz, \
    ((LPD3DINSTRUCTION) ptr)->wCount = cnt, \
    ptr = (void *)(((LPD3DINSTRUCTION) ptr) + 1) \
)

#define STATE_DATA(type, arg, ptr) \
(   ((LPD3DSTATE) ptr)->drstRenderStateType = (D3DRENDERSTATETYPE)type, \
    ((LPD3DSTATE) ptr)->dwArg[0] = arg, \
    ptr = (void *)(((LPD3DSTATE) ptr) + 1) \
)

class CMarni
{
public:
	CMarni();
	~CMarni();

	virtual int RequestVideoMemory();
	virtual int ChangeMode(int display_mode);
	virtual int ChangeResolution(int display_mode);
	virtual int ClearBg();
	//virtual int Clear(DWORD *a2, int a3, int a4, int a5);
	virtual int Render();
	virtual int Message(HWND hWnd, UINT Msg, WPARAM wParam, LPARAM lParam);
	virtual int CreateTexture(CMarniSurface *pSrf, DWORD *a3, DWORD *a4);
	virtual int CreateObject(DWORD *a2, DWORD a3);
	virtual int Release(int type);
	virtual int ClearBuffer(int type);
	virtual int Draw(DWORD *pPoly, int otz);
	virtual int InitPrims();

	HWND hWnd;
	int Render_w;
	int Render_h;
	int XSize;
	int YSize;
	int BitDepth;
	int ScreenX_old;
	int ScreenY_old;
	int BitDepth_old;
	int Is_fullscreen_old;
	int Texture_w;
	int Texture_h;
	float Aspect_x;
	float Aspect_y;
	int Is_gpu_init;
	int dwVidMemFree;
	int Scaling;
	float field_48;	// percentage of how many allocated surfaces use vram
	int field_4C;
	int field_50;
	CMarniSurface *pFBSurface;
	int field_58;
	int field_5C;
	int field_60;
	int Is_minimized;
	int Is_fullscreen;
	int field_6C;
	int Is_busy_;
	int Is_active;
	DWORD field_78[21];
	int field_CC;
	int Desktop_w;
	int Desktop_h;
	int BitsPerPixel;
	MARNI_RES Resolutions[32];
	int Resolution_count;
	int field_2E0;
	int Light_max;
	int Light_ambient;
	int ClearBG_;
	int ClearRGB;
	int field_2F4;
	int field_2F8;
	int field_2FC;
	int field_300;
	int field_304;
	int field_308;
	int card;
	int Softfull_rescnt;
	int display_mode;
	WORD *pTexture_buffer;
	float adjust_u;
	float adjust_v;
	CMarniPAlloc OTag0;
	CMarniPAlloc OTag1;
	D3DDEVICEDESC1 D3DHELDevDesc;
	D3DDEVICEDESC1 D3DHWDevDesc;
	int Use_VRAM;
	int field_4A8;
	int field_4AC;
	int Bpp_compatible;
	int field_4B4;
	int VRAM_available;
	int ddscapsSize;
	int Caps_depth;
	DWORD field_4C4;
	BYTE gap4C8[60];
	int field_504;
	int field_508;
	int field_50C;
	int field_510;
	int field_514;
	int field_518;
	int field_51C;
	int field_520;
	int field_524;
	int field_528;
	int field_52C;
	int field_530;
	int field_534;
	int field_538;
	int field_53C;
	int field_540;
	int field_544;
	int field_548;
	int field_54C;
	int field_550;
	int field_554;
	int field_558;
	int field_55C;
	int field_560;
	int field_564;
	int field_568;
	int field_56C;
	int field_570;
	int field_574;
	int field_578;
	int field_57C;
	int field_580;
	int field_584;
	int field_588;
	int field_58C;
	int field_590;
	int field_594;
	int field_598;
	int field_59C;
	int field_5A0;
	int field_5A4;
	int field_5A8;
	int field_5AC;
	int field_5B0;
	int field_5B4;
	int field_5B8;
	int field_5BC;
	int field_5C0;
	int field_5C4;
	int field_5C8;
	int field_5CC;
	int field_5D0;
	int field_5D4;
	int field_5D8;
	int field_5DC;
	int field_5E0;
	int field_5E4;
	int field_5E8;
	int field_5EC;
	int field_5F0;
	int field_5F4;
	int field_5F8;
	int field_5FC;
	int field_600;
	int field_604;
	int field_608;
	int field_60C;
	int field_610;
	int field_614;
	int field_618;
	int field_61C;
	int field_620;
	int field_624;
	int field_628;
	int field_62C;
	int field_630;
	int field_634;
	int field_638;
	int field_63C;
	int field_640;
	int field_644;
	int field_648;
	int field_64C;
	int field_650;
	int field_654;
	int field_658;
	int field_65C;
	int field_660;
	int field_664;
	int field_668;
	int field_66C;
	int field_670;
	int field_674;
	int field_678;
	int field_67C;
	int field_680;
	int field_684;
	int field_688;
	int field_68C;
	int field_690;
	int field_694;
	int field_698;
	int field_69C;
	int field_6A0;
	int field_6A4;
	int field_6A8;
	int field_6AC;
	int field_6B0;
	int field_6B4;
	int field_6B8;
	int field_6BC;
	int field_6C0;
	int field_6C4;
	int field_6C8;
	int field_6CC;
	int field_6D0;
	int field_6D4;
	int field_6D8;
	int field_6DC;
	int field_6E0;
	int field_6E4;
	int field_6E8;
	int field_6EC;
	int field_6F0;
	int field_6F4;
	int field_6F8;
	int field_6FC;
	int field_700;
	int field_704;
	int field_708;
	int field_70C;
	int field_710;
	int field_714;
	int field_718;
	int field_71C;
	int field_720;
	int field_724;
	int field_728;
	int field_72C;
	int field_730;
	int field_734;
	int field_738;
	int field_73C;
	int field_740;
	int field_744;
	int field_748;
	int field_74C;
	int field_750;
	int field_754;
	int field_758;
	int field_75C;
	int field_760;
	int field_764;
	int field_768;
	int field_76C;
	int field_770;
	int field_774;
	int field_778;
	int field_77C;
	int field_780;
	int field_784;
	int field_788;
	int field_78C;
	int field_790;
	int field_794;
	int field_798;
	int field_79C;
	int field_7A0;
	int field_7A4;
	int field_7A8;
	int field_7AC;
	int field_7B0;
	int field_7B4;
	int field_7B8;
	int field_7BC;
	int field_7C0;
	int field_7C4;
	int field_7C8;
	int field_7CC;
	int field_7D0;
	int field_7D4;
	int field_7D8;
	int field_7DC;
	int field_7E0;
	int field_7E4;
	int field_7E8;
	int field_7EC;
	int field_7F0;
	int field_7F4;
	int field_7F8;
	int field_7FC;
	int field_800;
	int field_804;
	int field_808;
	int field_80C;
	int field_810;
	int field_814;
	int field_818;
	int field_81C;
	int field_820;
	int field_824;
	int field_828;
	int field_82C;
	int field_830;
	int field_834;
	int field_838;
	int field_83C;
	int field_840;
	int field_844;
	int field_848;
	int field_84C;
	int field_850;
	int field_854;
	int field_858;
	int field_85C;
	int field_860;
	int field_864;
	int field_868;
	int field_86C;
	int field_870;
	int field_874;
	int field_878;
	int field_87C;
	int field_880;
	int field_884;
	int field_888;
	int field_88C;
	int field_890;
	int field_894;
	int field_898;
	int field_89C;
	int field_8A0;
	int field_8A4;
	int field_8A8;
	int field_8AC;
	int field_8B0;
	int field_8B4;
	int field_8B8;
	int field_8BC;
	int field_8C0;
	int field_8C4;
	int field_8C8;
	int field_8CC;
	int field_8D0;
	int field_8D4;
	int field_8D8;
	int field_8DC;
	int *pPtr_2KBuffer;
	int cnt_pPtr_2K;
	int field_8E8;
	int field_8EC;
	int field_8F0;
	int field_8F4;
	CMarni216 *pSurfaces[513];
	int field_10FC;
	int field_1100;
	int field_1104;
	int field_1108;
	int field_110C;
	int System_memory;
	int field_1114;
	int Surf_desc_cnt;
	DDSURFACEDESC Surf_desc[9];
	int field_14E8;
	int field_14EC;
	int field_14F0;
	int field_14F4;
	int field_14F8;
	int field_14FC;
	int field_1500;
	int field_1504;
	int field_1508;
	int field_150C;
	int field_1510;
	int field_1514;
	int field_1518;
	int field_151C;
	int field_1520;
	int field_1524;
	int field_1528;
	int field_152C;
	int field_1530;
	int field_1534;
	int field_1538;
	int field_153C;
	int field_1540;
	int field_1544;
	int field_1548;
	int field_154C;
	int field_1550;
	D3DMATRIXHANDLE MatrixHandle0;
	D3DMATRIXHANDLE MatrixHandle1;
	D3DMATRIXHANDLE MatrixHandle2;
	D3DMATRIXHANDLE MatrixHandle3;
	D3DMATRIXHANDLE MatrixHandle4;
	D3DMATRIXHANDLE MatrixHandle5;
	RECT Resolution_rect;
	int field_157C;
	int field_1580;
	int field_1584;
	int field_1588;
	int field_158C;
	int field_1590;
	int field_1594;
	int field_1598;
	int field_159C;
	int field_15A0;
	int field_15A4;
	int field_15A8;
	int field_15AC;
	int field_15B0;
	int field_15B4;
	int field_15B8;
	int field_15BC;
	int field_15C0;
	int field_15C4;
	int field_15C8;
	int field_15CC;
	int field_15D0;
	int field_15D4;
	int field_15D8;
	int field_15DC;
	int field_15E0;
	int field_15E4;
	int field_15E8;
	int field_15EC;
	int field_15F0;
	int field_15F4;
	int field_15F8;
	int field_15FC;
	int field_1600;
	int field_1604;
	int field_1608;
	int field_160C;
	int field_1610;
	int field_1614;
	int field_1618;
	int field_161C;
	int field_1620;
	int field_1624;
	int field_1628;
	int field_162C;
	int field_1630;
	int field_1634;
	int field_1638;
	int field_163C;
	int field_1640;
	int field_1644;
	int field_1648;
	int field_164C;
	int field_1650;
	int field_1654;
	int field_1658;
	int field_165C;
	int field_1660;
	int field_1664;
	int field_1668;
	int field_166C;
	int field_1670;
	int field_1674;
	int field_1678;
	int field_167C;
	int field_1680;
	int field_1684;
	int field_1688;
	int field_168C;
	int field_1690;
	int field_1694;
	int field_1698;
	int field_169C;
	int field_16A0;
	int field_16A4;
	int field_16A8;
	int field_16AC;
	int field_16B0;
	int field_16B4;
	int field_16B8;
	int field_16BC;
	int field_16C0;
	int field_16C4;
	int field_16C8;
	int field_16CC;
	int field_16D0;
	int field_16D4;
	int field_16D8;
	int field_16DC;
	int field_16E0;
	int field_16E4;
	int field_16E8;
	int field_16EC;
	int field_16F0;
	int field_16F4;
	int field_16F8;
	int field_16FC;
	int field_1700;
	int field_1704;
	int field_1708;
	int field_170C;
	int field_1710;
	int field_1714;
	int field_1718;
	int field_171C;
	int field_1720;
	int field_1724;
	int field_1728;
	int field_172C;
	int field_1730;
	int field_1734;
	int field_1738;
	int field_173C;
	int field_1740;
	int field_1744;
	int field_1748;
	int field_174C;
	int field_1750;
	int field_1754;
	int field_1758;
	int field_175C;
	int field_1760;
	int field_1764;
	int field_1768;
	int field_176C;
	int field_1770;
	int field_1774;
	int field_1778;
	int field_177C;
	int field_1780;
	int field_1784;
	int field_1788;
	int field_178C;
	int field_1790;
	int field_1794;
	int field_1798;
	int field_179C;
	int field_17A0;
	int field_17A4;
	int field_17A8;
	int field_17AC;
	int field_17B0;
	int field_17B4;
	int field_17B8;
	int field_17BC;
	int field_17C0;
	int field_17C4;
	int field_17C8;
	int field_17CC;
	int field_17D0;
	int field_17D4;
	int field_17D8;
	int field_17DC;
	int field_17E0;
	int field_17E4;
	int field_17E8;
	int field_17EC;
	int field_17F0;
	int field_17F4;
	int field_17F8;
	int field_17FC;
	int field_1800;
	int field_1804;
	int field_1808;
	int field_180C;
	int field_1810;
	int field_1814;
	int field_1818;
	int field_181C;
	int field_1820;
	int field_1824;
	int field_1828;
	int field_182C;
	int field_1830;
	int field_1834;
	int field_1838;
	int field_183C;
	int field_1840;
	int field_1844;
	int field_1848;
	int field_184C;
	int field_1850;
	int field_1854;
	int field_1858;
	int field_185C;
	int field_1860;
	int field_1864;
	int field_1868;
	int field_186C;
	int field_1870;
	int field_1874;
	int field_1878;
	int field_187C;
	int field_1880;
	int field_1884;
	int field_1888;
	int field_188C;
	int field_1890;
	int field_1894;
	int field_1898;
	int field_189C;
	int field_18A0;
	int field_18A4;
	int field_18A8;
	int field_18AC;
	int field_18B0;
	int field_18B4;
	int field_18B8;
	int field_18BC;
	int field_18C0;
	int field_18C4;
	int field_18C8;
	int field_18CC;
	int field_18D0;
	int field_18D4;
	int field_18D8;
	int field_18DC;
	int field_18E0;
	int field_18E4;
	int field_18E8;
	int field_18EC;
	int field_18F0;
	int field_18F4;
	int field_18F8;
	int field_18FC;
	int field_1900;
	int field_1904;
	int field_1908;
	int field_190C;
	int field_1910;
	int field_1914;
	int field_1918;
	int field_191C;
	int field_1920;
	int field_1924;
	int field_1928;
	int field_192C;
	int field_1930;
	int field_1934;
	int field_1938;
	int field_193C;
	int field_1940;
	int field_1944;
	int field_1948;
	int field_194C;
	int field_1950;
	int field_1954;
	int field_1958;
	int field_195C;
	int field_1960;
	int field_1964;
	int field_1968;
	int field_196C;
	int field_1970;
	int field_1974;
	int field_1978;
	int field_197C;
	int field_1980;
	int field_1984;
	int field_1988;
	int field_198C;
	int field_1990;
	int field_1994;
	int field_1998;
	int field_199C;
	int field_19A0;
	int field_19A4;
	int field_19A8;
	int field_19AC;
	int field_19B0;
	int field_19B4;
	int field_19B8;
	int field_19BC;
	int field_19C0;
	int field_19C4;
	int field_19C8;
	int field_19CC;
	int field_19D0;
	int field_19D4;
	int field_19D8;
	int field_19DC;
	int field_19E0;
	int field_19E4;
	int field_19E8;
	int field_19EC;
	int field_19F0;
	int field_19F4;
	int field_19F8;
	int field_19FC;
	int field_1A00;
	int field_1A04;
	int field_1A08;
	int field_1A0C;
	int field_1A10;
	int field_1A14;
	int field_1A18;
	int field_1A1C;
	int field_1A20;
	int field_1A24;
	int field_1A28;
	int field_1A2C;
	int field_1A30;
	int field_1A34;
	int field_1A38;
	int field_1A3C;
	int field_1A40;
	int field_1A44;
	int field_1A48;
	int field_1A4C;
	int field_1A50;
	int field_1A54;
	int field_1A58;
	int field_1A5C;
	int field_1A60;
	int field_1A64;
	int field_1A68;
	int field_1A6C;
	int field_1A70;
	int field_1A74;
	int field_1A78;
	int field_1A7C;
	int field_1A80;
	int field_1A84;
	int field_1A88;
	int field_1A8C;
	int field_1A90;
	int field_1A94;
	int field_1A98;
	int field_1A9C;
	int field_1AA0;
	int field_1AA4;
	int field_1AA8;
	int field_1AAC;
	int field_1AB0;
	int field_1AB4;
	int field_1AB8;
	int field_1ABC;
	int field_1AC0;
	int field_1AC4;
	int field_1AC8;
	int field_1ACC;
	int field_1AD0;
	int field_1AD4;
	int field_1AD8;
	int field_1ADC;
	int field_1AE0;
	int field_1AE4;
	int field_1AE8;
	int field_1AEC;
	int field_1AF0;
	int field_1AF4;
	int field_1AF8;
	int field_1AFC;
	int field_1B00;
	int field_1B04;
	int field_1B08;
	int field_1B0C;
	int field_1B10;
	int field_1B14;
	int field_1B18;
	int field_1B1C;
	int field_1B20;
	int field_1B24;
	int field_1B28;
	int field_1B2C;
	int field_1B30;
	int field_1B34;
	int field_1B38;
	int field_1B3C;
	int field_1B40;
	int field_1B44;
	int field_1B48;
	int field_1B4C;
	int field_1B50;
	int field_1B54;
	int field_1B58;
	int field_1B5C;
	int field_1B60;
	int field_1B64;
	int field_1B68;
	int field_1B6C;
	int field_1B70;
	int field_1B74;
	int field_1B78;
	int field_1B7C;
	int field_1B80;
	int field_1B84;
	int field_1B88;
	int field_1B8C;
	int field_1B90;
	int field_1B94;
	int field_1B98;
	int field_1B9C;
	int field_1BA0;
	int field_1BA4;
	int field_1BA8;
	int field_1BAC;
	int field_1BB0;
	int field_1BB4;
	int field_1BB8;
	int field_1BBC;
	int field_1BC0;
	int field_1BC4;
	int field_1BC8;
	int field_1BCC;
	int field_1BD0;
	int field_1BD4;
	int field_1BD8;
	int field_1BDC;
	int field_1BE0;
	int field_1BE4;
	int field_1BE8;
	int field_1BEC;
	int field_1BF0;
	int field_1BF4;
	int field_1BF8;
	int field_1BFC;
	int field_1C00;
	int field_1C04;
	int field_1C08;
	int field_1C0C;
	int field_1C10;
	int field_1C14;
	int field_1C18;
	int field_1C1C;
	int field_1C20;
	int field_1C24;
	int field_1C28;
	int field_1C2C;
	int field_1C30;
	int field_1C34;
	int field_1C38;
	int field_1C3C;
	int field_1C40;
	int field_1C44;
	int field_1C48;
	int field_1C4C;
	int field_1C50;
	int field_1C54;
	int field_1C58;
	int field_1C5C;
	int field_1C60;
	int field_1C64;
	int field_1C68;
	int field_1C6C;
	int field_1C70;
	int field_1C74;
	int field_1C78;
	int field_1C7C;
	int field_1C80;
	int field_1C84;
	int field_1C88;
	int field_1C8C;
	int field_1C90;
	int field_1C94;
	int field_1C98;
	int field_1C9C;
	int field_1CA0;
	int field_1CA4;
	int field_1CA8;
	int field_1CAC;
	int field_1CB0;
	int field_1CB4;
	int field_1CB8;
	int field_1CBC;
	int field_1CC0;
	int field_1CC4;
	int field_1CC8;
	int field_1CCC;
	int field_1CD0;
	int field_1CD4;
	int field_1CD8;
	int field_1CDC;
	int field_1CE0;
	int field_1CE4;
	int field_1CE8;
	int field_1CEC;
	int field_1CF0;
	int field_1CF4;
	int field_1CF8;
	int field_1CFC;
	int field_1D00;
	int field_1D04;
	int field_1D08;
	int field_1D0C;
	int field_1D10;
	int field_1D14;
	int field_1D18;
	int field_1D1C;
	int field_1D20;
	int field_1D24;
	int field_1D28;
	int field_1D2C;
	int field_1D30;
	int field_1D34;
	int field_1D38;
	int field_1D3C;
	int field_1D40;
	int field_1D44;
	int field_1D48;
	int field_1D4C;
	int field_1D50;
	int field_1D54;
	int field_1D58;
	int field_1D5C;
	int field_1D60;
	int field_1D64;
	int field_1D68;
	int field_1D6C;
	int field_1D70;
	int field_1D74;
	int field_1D78;
	IDirectDrawClipper *Clipper;
	int field_1D80;		// seems to be yet another directdraw object, it's mentioned inside Destroy()
	IDirectDraw *pDirectDraw;
	IDirectDraw *g_pDD;
	LPDIRECT3DLIGHT pD3DLight[6];
	int field_1DA4;
	int field_1DA8;
	int field_1DAC;
	MARNI_SOFTLIGHT Soft_Light[6];
	int field_1E40;
	int field_1E44;
	int field_1E48;
	int field_1E4C;
	int field_1E50;
	int field_1E54;
	int field_1E58;
	int field_1E5C;
	int field_1E60;
	int field_1E64;
	int field_1E68;
	int field_1E6C;
	int field_1E70;
	int field_1E74;
	int field_1E78;
	int field_1E7C;
	int field_1E80;
	int field_1E84;
	int field_1E88;
	int field_1E8C;
	int field_1E90;
	int field_1E94;
	int field_1E98;
	int field_1E9C;
	int field_1EA0;
	int field_1EA4;
	int field_1EA8;
	int field_1EAC;
	int field_1EB0;
	int field_1EB4;
	int field_1EB8;
	int field_1EBC;
	int field_1EC0;
	IDirect3DExecuteBuffer* pExecuteBuffer;
	IDirect3DMaterial* Material;
	D3DMATERIALHANDLE MaterialHandle;
	IDirect3D *pZBuffer_;
	LPDIRECT3DDEVICE pD3DDevice;
	IDirect3DViewport* pViewport;
	int field_1EDC;
	MARNI_MATRIX Matrix0;
	MARNI_MATRIX Matrix1;
	MARNI_MATRIX Matrix2;
	MARNI_MATRIX Matrix3;
	MARNI_MATRIX Matrix5;
	MARNI_MATRIX Matrix4;
	int field_2060;
	CMarniSurface MarniBitsMain;
	CMarniSurface MarniBits1;
	CMarniSurface MarniBitsDst;
	CMarniSurface2 MarniSrf2;
	int DeviceID;

	CMarni* Init(HWND hWnd, int screen_w, int screen_h, int display_mode, int display_driver);
	void Initialize(HWND hWnd, int screen_w, int screen_h);
	int InitAll();

	void GetZDepthCaps();

	UINT message_loop(HWND hWnd, UINT Msg, WPARAM wParam, LPARAM lParam);
	void wm_move();
	int  Test_textures();

	int ReloadTexture();
	int ReloadTexture(int index);
	int ReloadTexture0(DWORD dwFlags);

	int DetectGpuDriver();
	int MD3DCreateDirect3D();
	int MD3DCreateZBuffer(int Width, int Height, LPDIRECTDRAWSURFACE *a4);
	int createDevice();

	//int RequestVideoMemory();
	int SearchMatchTextureFormat(CMarniSurface2 *pSurface, DDSURFACEDESC *pDesc);

	//
	void ClientToScreen();
	void Destroy();
	int  Resize(HWND hWnd, UINT Msg, WPARAM wParam, LPARAM lParam);

	void ClearBuffers();

	void Vmem_stats();

	int RestoreLostSurface();
	void Clear();

	int RequestDisplayRect(int id, MARNI_RES *res);
	int RequestDisplayModeCount();
	int CMarni::ChangeResolution(int dwWidth, int dwHeight, int dwBPP);
};

